# 第三方应用上滑进入最近任务动画原理

## 概述

在Android Launcher3中,当用户从第三方应用底部上滑进入最近任务(Recents)界面时,系统会启动一套复杂的动画机制。这套机制通过精密的手势检测、动画控制和Surface变换,实现了流畅的应用缩放预览效果。

本文档详细分析这一过程中涉及的核心类和工作流程。

---

## 核心类介绍

### 1. OtherActivityInputConsumer

**文件位置**: `quickstep/src/com/android/quickstep/inputconsumers/OtherActivityInputConsumer.java`

**核心职责**:
- 处理来自第三方应用的触摸输入事件
- 检测上滑手势并判断手势类型(快速切换/进入最近任务)
- 启动Recents动画并创建AbsSwipeUpHandler
- 拦截触摸事件(pilferPointers)防止事件传递给其他组件

**关键成员变量**:
```java
private AbsSwipeUpHandler mInteractionHandler;  // 手势处理器
private final GestureState mGestureState;       // 手势状态
private RecentsAnimationCallbacks mActiveCallbacks; // 动画回调
private VelocityTracker mVelocityTracker;       // 速度追踪
private final float mTouchSlop;                 // 触摸阈值
private boolean mPassedWindowMoveSlop;          // 是否超过窗口移动阈值
private boolean mPassedPilferInputSlop;         // 是否超过事件拦截阈值
```

**关键方法**:
- `onMotionEvent(MotionEvent ev)`: 处理所有触摸事件
- `startTouchTrackingForWindowAnimation(long touchTimeMs)`: 启动动画追踪
- `notifyGestureStarted(boolean isLikelyToStartNewTask)`: 通知手势开始,拦截后续事件

### 2. AbsSwipeUpHandler

**文件位置**: `quickstep/src/com/android/quickstep/AbsSwipeUpHandler.java`

**核心职责**:
- 协调整个上滑手势的动画流程
- 管理状态机,控制动画的各个阶段
- 处理RecentsAnimation的生命周期
- 控制TaskViewSimulator进行窗口变换

**关键成员变量**:
```java
protected RecentsAnimationController mRecentsAnimationController;  // 动画控制器
protected RecentsAnimationTargets mRecentsAnimationTargets;        // 动画目标
protected RECENTS_VIEW mRecentsView;                               // 最近任务视图
protected MultiStateCallback mStateCallback;                       // 状态回调管理器
private AnimatorControllerWithResistance mLauncherTransitionController; // Launcher过渡控制器
protected final AnimatedFloat mCurrentShift;                       // 当前偏移量 [0,1]
private RemoteTargetHandle[] mRemoteTargetHandles;                 // 远程目标句柄数组
```

**状态标志**:
```java
STATE_LAUNCHER_PRESENT          // Launcher已存在
STATE_LAUNCHER_STARTED          // Launcher已启动
STATE_LAUNCHER_DRAWN            // Launcher已绘制
STATE_GESTURE_STARTED           // 手势已开始
STATE_GESTURE_COMPLETED         // 手势已完成
STATE_APP_CONTROLLER_RECEIVED   // 接收到应用控制器
STATE_SCREENSHOT_CAPTURED       // 截图已捕获
```

**关键方法**:
- `onRecentsAnimationStart()`: RecentsAnimation启动时的回调
- `updateDisplacement(float displacement)`: 更新手势位移
- `onGestureEnded()`: 手势结束处理
- `initializeLauncherAnimationController()`: 初始化Launcher动画控制器

### 3. RecentsAnimationTargets

**文件位置**: `quickstep/src/com/android/quickstep/RecentsAnimationTargets.java`

**核心职责**:
- 封装RecentsAnimation的目标窗口信息
- 提供应用窗口、壁纸、非应用窗口等目标的访问接口
- 包含Home界面的内容插入边距和最小化边界信息

**关键成员变量**:
```java
public final RemoteAnimationTarget[] apps;          // 应用窗口目标数组
public final RemoteAnimationTarget[] wallpapers;    // 壁纸目标数组
public final RemoteAnimationTarget[] nonApps;       // 非应用窗口目标数组
public final Rect homeContentInsets;                // Home内容插入边距
public final Rect minimizedHomeBounds;              // 最小化的Home边界
public final int targetMode;                        // 目标模式(MODE_CLOSING等)
```

### 4. TaskViewSimulator

**文件位置**: `quickstep/src/com/android/quickstep/util/TaskViewSimulator.java`

**核心职责**:
- 模拟TaskView的布局和变换行为
- 计算任务窗口从全屏到最近任务视图的缩放、平移、裁剪等变换
- 实现TransformParams.BuilderProxy接口,应用变换到Surface

**关键成员变量**:
```java
private final Matrix mMatrix;                       // 变换矩阵
private final Rect mTaskRect;                       // 任务矩形
private final Rect mFullTaskSize;                   // 全屏任务大小
private RecentsOrientedState mOrientationState;     // 方向状态
private final PreviewPositionHelper mPositionHelper; // 预览位置辅助器

// 动画属性
public final AnimatedFloat taskPrimaryTranslation;   // 主方向平移
public final AnimatedFloat taskSecondaryTranslation; // 次方向平移
public final AnimatedFloat recentsViewScale;         // RecentsView缩放
public final AnimatedFloat fullScreenProgress;       // 全屏进度 [0,1]
```

**关键方法**:
- `setPreview(RemoteAnimationTarget runningTarget)`: 设置预览目标
- `apply(TransformParams params)`: 应用变换参数
- `getFullScreenScale()`: 获取全屏缩放比例
- `onBuildTargetParams()`: 构建目标Surface参数

### 5. TransformParams

**文件位置**: `quickstep/src/com/android/quickstep/util/TransformParams.java`

**核心职责**:
- 管理窗口变换的所有参数
- 控制动画进度、透明度、圆角半径等属性
- 生成SurfaceTransaction并应用到窗口Surface

**关键成员变量**:
```java
private float mProgress;                            // 进度 [0,1], 0=应用内, 1=Overview
private float mTargetAlpha;                         // 目标透明度
private float mCornerRadius;                        // 圆角半径
private RemoteAnimationTargets mTargetSet;          // 动画目标集合
private SurfaceTransactionApplier mSyncTransactionApplier; // Surface事务应用器
private BuilderProxy mHomeBuilderProxy;             // Home构建代理
private BuilderProxy mBaseBuilderProxy;             // 基础构建代理
```

**关键方法**:
- `setProgress(float progress)`: 设置动画进度
- `createSurfaceParams(BuilderProxy proxy)`: 创建Surface参数
- `applySurfaceParams(SurfaceTransaction builder)`: 应用Surface参数

**BuilderProxy接口**:
```java
@FunctionalInterface
public interface BuilderProxy {
    void onBuildTargetParams(SurfaceProperties builder,
            RemoteAnimationTarget app, TransformParams params);
}
```

---

## 工作流程详解

### 阶段1: 触摸事件检测与手势识别

```
用户触摸屏幕底部导航区域
    ↓
OtherActivityInputConsumer.onMotionEvent(ACTION_DOWN)
    ↓
记录触摸起点 mDownPos
初始化 VelocityTracker
    ↓
判断 mIsDeferredDownTarget (是否延迟目标)
    ├─ false → 立即调用 startTouchTrackingForWindowAnimation()
    └─ true  → 等待 ACTION_MOVE 超过阈值后再启动
```

#### ACTION_MOVE 处理逻辑

```java
// OtherActivityInputConsumer.java:282-396

case ACTION_MOVE:
    1. 计算位移量:
       - displacement = getDisplacement(ev)  // 垂直方向位移
       - displacementX/Y = 当前位置 - 起点位置

    2. 检查是否超过移动阈值:
       if (!mPassedWindowMoveSlop) {
           if (Math.abs(displacement) > mTouchSlop) {
               mPassedWindowMoveSlop = true;
           }
       }

    3. 计算滑动角度并判断手势类型:
       double degrees = Math.toDegrees(Math.atan(upDist / horizontalDist));

       // 角度在±15度内 → 快速切换任务(QuickSwitch)
       boolean swipeWithinQuickSwitchRange = degrees <= OVERVIEW_MIN_DEGREES;

       // 角度>15度 → 进入最近任务
       boolean isLikelyToStartNewTask = haveNotPassedSlopOnContinuedGesture
                                      || swipeWithinQuickSwitchRange;

    4. 如果超过拦截阈值:
       if (!mPassedPilferInputSlop && passedSlop) {
           mPassedPilferInputSlop = true;

           // 延迟目标在此时启动动画
           if (mIsDeferredDownTarget) {
               startTouchTrackingForWindowAnimation(ev.getEventTime());
           }

           // 拦截后续触摸事件,通知手势开始
           notifyGestureStarted(isLikelyToStartNewTask);
       }

    5. 更新 mInteractionHandler 的位移:
       if (mInteractionHandler != null && mPassedWindowMoveSlop) {
           mInteractionHandler.updateDisplacement(displacement - mStartDisplacement);
       }
```

### 阶段2: 启动RecentsAnimation

```
startTouchTrackingForWindowAnimation()
    ↓
创建 AbsSwipeUpHandler
mInteractionHandler = mHandlerFactory.newHandler(mGestureState, touchTimeMs)
    ↓
设置手势结束回调
mInteractionHandler.setGestureEndCallback(this::onInteractionGestureFinished)
    ↓
初始化 handler
mInteractionHandler.initWhenReady()
    ↓
判断是否已有RecentsAnimation正在运行
    ├─ YES → continueRecentsAnimation()  // 继续已有动画
    └─ NO  → startRecentsAnimation()     // 启动新动画
              ↓
        TaskAnimationManager.startRecentsAnimation()
              ↓
        调用系统API启动RecentsAnimation
        RecentsAnimationController.startRecentsActivity()
              ↓
        等待系统回调 onRecentsAnimationStart()
```

### 阶段3: RecentsAnimation启动回调

```
AbsSwipeUpHandler.onRecentsAnimationStart(controller, targets, transitionInfo)
    ↓
1. 保存动画控制器和目标
   mRecentsAnimationController = controller
   mRecentsAnimationTargets = targets
    ↓
2. 分配目标到 RemoteTargetHandle
   if (targets.hasDesktopTasks()) {
       mRemoteTargetHandles = mTargetGluer.assignTargetsForDesktop(targets)
   } else {
       mRemoteTargetHandles = mTargetGluer.assignTargetsForSplitScreen(targets)
   }
    ↓
3. 初始化 TaskViewSimulator
   for (RemoteTargetHandle handle : mRemoteTargetHandles) {
       TaskViewSimulator simulator = handle.getTaskViewSimulator();
       simulator.setPreview(runningTarget);
       simulator.setOrientationState(orientationState);
   }
    ↓
4. 设置 TransformParams
   mTransformParams.setTargetSet(targets)
   mTransformParams.setSyncTransactionApplier(applier)
    ↓
5. 设置状态标志
   mStateCallback.setState(STATE_APP_CONTROLLER_RECEIVED)
    ↓
6. 触发后续状态机流程
   - STATE_LAUNCHER_DRAWN | STATE_GESTURE_STARTED
     → initializeLauncherAnimationController()
```

### 阶段4: 实时更新窗口变换

当用户手指在屏幕上移动时:

```
OtherActivityInputConsumer.onMotionEvent(ACTION_MOVE)
    ↓
mInteractionHandler.updateDisplacement(displacement)
    ↓
AbsSwipeUpHandler.updateDisplacement(float displacement)
    ↓
// 计算进度值 [0, 1]
float shift = displacement / mTransitionDragLength;
mCurrentShift.updateValue(shift);
    ↓
onCurrentShiftUpdated()
    ↓
更新每个 RemoteTargetHandle:
    for (RemoteTargetHandle handle : mRemoteTargetHandles) {
        TaskViewSimulator simulator = handle.getTaskViewSimulator();

        // 更新动画属性
        simulator.fullScreenProgress.value = mCurrentShift.value;
        simulator.recentsViewScale.value = getRecentsViewScale();
        simulator.taskPrimaryTranslation.value = calculateTranslation();

        // 应用变换
        simulator.apply(mTransformParams);
    }
    ↓
TaskViewSimulator.apply(TransformParams params)
    ↓
1. 计算变换矩阵:
   mMatrix.set(mPositionHelper.getMatrix())          // 缩略图矩阵
   mMatrix.postTranslate(mTaskRect.left, mTaskRect.top) // TaskView位置
   mMatrix.postScale(recentsViewScale, recentsViewScale, pivot) // RecentsView缩放
   mMatrix.postTranslate(recentsViewTranslation)     // RecentsView平移
   applyWindowToHomeRotation(mMatrix)                // 应用旋转
    ↓
2. 计算裁剪区域:
   mInversePositionMatrix.mapRect(cropRect)
    ↓
3. 计算圆角半径:
   float cornerRadius = getCurrentCornerRadius()
    ↓
4. 构建 SurfaceParams:
   params.createSurfaceParams(this)
       → onBuildTargetParams(builder, app, params)
           builder.setMatrix(mMatrix)
                  .setWindowCrop(cropRect)
                  .setCornerRadius(cornerRadius)
                  .setAlpha(alpha)
    ↓
5. 应用到Surface:
   params.applySurfaceParams(surfaceTransaction)
       ↓
   mSyncTransactionApplier.scheduleApply(surfaceTransaction)
       ↓
   surfaceTransaction.getTransaction().apply()
```

### 阶段5: 手势结束处理

```
用户抬起手指
    ↓
OtherActivityInputConsumer.onMotionEvent(ACTION_UP)
    ↓
finishTouchTracking(ev)
    ↓
if (mPassedWindowMoveSlop && mInteractionHandler != null) {
    // 计算速度
    mVelocityTracker.computeCurrentVelocity(PX_PER_MS)
    float velocity = mVelocityTracker.getYVelocity()

    // 调用手势结束
    mInteractionHandler.onGestureEnded(velocity, velocityPxPerMs, ...)
}
    ↓
AbsSwipeUpHandler.onGestureEnded(float endVelocity, PointF velocity, ...)
    ↓
handleNormalGestureEnd(endVelocity, isFling, velocity, ...)
    ↓
// 根据速度和位移判断终点目标
GestureEndTarget endTarget = calculateEndTarget(
    velocity, endVelocity, isSwipingUp, isFling
);

endTarget 可能是:
    - HOME: 回到桌面
    - RECENTS: 进入最近任务
    - LAST_TASK: 返回当前应用
    - NEW_TASK: 切换到其他任务
    ↓
animateToProgress(endTarget, ...)
    ↓
根据不同的 endTarget 执行不同动画:
    ├─ HOME: animateToHomeAndFinish()
    │        → 启动RectFSpringAnim弹簧动画
    │        → 应用窗口缩小到Hotseat区域
    │
    ├─ RECENTS: createWindowAnimationToHome()
    │            → 平滑过渡到最近任务界面
    │            → 显示RecentsView
    │
    └─ LAST_TASK: finishCurrentTransitionToRecents()
                  → 取消动画,保持当前应用
```

---

## ASCII流程示意图

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户触摸输入                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              OtherActivityInputConsumer                          │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ • onMotionEvent(ACTION_DOWN/MOVE/UP)                   │    │
│  │ • 手势检测(角度、速度、距离)                             │    │
│  │ • pilferPointers() 拦截事件                             │    │
│  └──────────────────┬─────────────────────────────────────┘    │
└─────────────────────┼──────────────────────────────────────────┘
                      │
                      │ 创建并启动
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│              AbsSwipeUpHandler (手势处理核心)                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │ • 状态机管理 (MultiStateCallback)                       │    │
│  │ • updateDisplacement() - 更新位移                       │    │
│  │ • onGestureEnded() - 处理手势结束                       │    │
│  │ • 协调各组件工作                                        │    │
│  └──────┬─────────────┬──────────────┬────────────────────┘    │
└─────────┼─────────────┼──────────────┼─────────────────────────┘
          │             │              │
          │             │              │
      启动│         管理│          使用│
          │             │              │
          ▼             ▼              ▼
┌──────────────┐ ┌─────────────┐ ┌────────────────────┐
│TaskAnimation │ │  Recents    │ │RemoteTargetHandle[]│
│   Manager    │ │ Animation   │ │                    │
│              │ │  Targets    │ │ 包含:              │
│启动Recents   │ │             │ │ • TaskViewSimulator│
│Animation     │ │ • apps[]    │ │ • TransformParams  │
└──────┬───────┘ │ • wallpapers│ └─────────┬──────────┘
       │         │ • homeInsets│           │
       │         └─────────────┘           │
       │                                   │
       │ 回调                         更新变换│
       ▼                                   ▼
┌──────────────────────┐         ┌──────────────────────┐
│RecentsAnimation      │         │  TaskViewSimulator   │
│   Controller         │         │                      │
│                      │         │ • 计算变换矩阵       │
│• finish()            │         │ • 计算裁剪区域       │
│• setAnimationTarget  │         │ • 计算圆角半径       │
│  Controller()        │         │ • apply()            │
└──────────────────────┘         └──────┬───────────────┘
                                        │
                                        │ 生成
                                        ▼
                                ┌──────────────────┐
                                │ TransformParams  │
                                │                  │
                                │ • setProgress()  │
                                │ • createSurface  │
                                │   Params()       │
                                └────────┬─────────┘
                                         │
                                         │ 应用
                                         ▼
                                ┌──────────────────┐
                                │ SurfaceControl   │
                                │   Transaction    │
                                │                  │
                                │ • setMatrix()    │
                                │ • setWindowCrop()│
                                │ • setCorner      │
                                │   Radius()       │
                                │ • apply()        │
                                └──────────────────┘
                                         │
                                         ▼
                              ┌───────────────────────┐
                              │    第三方应用窗口      │
                              │   实时缩放、平移显示   │
                              └───────────────────────┘
```

### 手势检测状态转换图

```
       用户触摸屏幕
            │
            ▼
    ┌───────────────┐
    │  ACTION_DOWN  │
    └───────┬───────┘
            │
            │ mDownPos = (x, y)
            │ mActivePointerId = 0
            │
            ▼
    ┌─────────────────────┐
    │  等待 ACTION_MOVE   │
    └──────────┬──────────┘
               │
               ▼
        ┌──────────────┐
        │  计算位移量   │ displacement = current - start
        │  计算角度    │ degrees = atan(upDist / horizontalDist)
        └──────┬───────┘
               │
               ▼
        ┌──────────────────────────┐
        │ 检查是否超过 TouchSlop    │
        └──┬──────────────────┬────┘
           │ NO               │ YES
           ▼                  ▼
      继续等待        ┌────────────────┐
                      │ passedSlop = true│
                      └────────┬─────────┘
                               │
                ┌──────────────┴──────────────┐
                │                             │
         degrees <= 15°                degrees > 15°
      (快速切换任务)                   (进入Overview)
                │                             │
                ▼                             ▼
    ┌──────────────────┐          ┌─────────────────────┐
    │isLikelyToStartNew│          │ 进入最近任务模式     │
    │Task = true       │          │                     │
    └──────────────────┘          └─────────────────────┘
                │                             │
                └──────────────┬──────────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │ mPassedPilferInput  │
                    │ Slop = true         │
                    └──────────┬──────────┘
                               │
                ┌──────────────┴─────────────┐
                │                            │
           mIsDeferredDown              已启动动画
           Target = true                     │
                │                            │
                ▼                            ▼
      startTouchTracking          notifyGestureStarted()
      ForWindowAnimation()                   │
                │                            │
                └────────────┬───────────────┘
                             │
                             ▼
                  ┌─────────────────────┐
                  │ pilferPointers()    │
                  │ (拦截后续触摸事件)   │
                  └──────────┬──────────┘
                             │
                             ▼
                  ┌─────────────────────┐
                  │  持续处理 MOVE 事件  │
                  │  updateDisplacement()│
                  └──────────┬──────────┘
                             │
                             ▼
                       ACTION_UP/CANCEL
                             │
                             ▼
                  ┌─────────────────────┐
                  │ onGestureEnded()    │
                  │ • 计算速度           │
                  │ • 确定结束目标       │
                  │ • 执行结束动画       │
                  └─────────────────────┘
```

---

## 时序图

### 完整上滑手势时序图

```
用户   InputConsumer   AbsSwipeUp    TaskAnimation   RecentsAnimation   TaskView      Transform   SurfaceControl
       (触摸处理)      Handler        Manager        Controller       Simulator      Params      Transaction
 │          │             │              │                │               │             │              │
 │ Touch ──→│             │              │                │               │             │              │
 │  DOWN    │             │              │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │ 判断是否     │              │                │               │             │              │
 │          │ 延迟启动     │              │                │               │             │              │
 │          │             │              │                │               │             │              │
 │ Touch ──→│             │              │                │               │             │              │
 │  MOVE    │ 计算位移    │              │                │               │             │              │
 │          │ 计算角度    │              │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │ 超过阈值    │              │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │ start──────→│              │                │               │             │              │
 │          │ TouchTracking create      │                │               │             │              │
 │          │             │ Handler      │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │initWhenReady │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │startRecents─→│                │               │             │              │
 │          │             │ Animation    │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │              │ call system ──→│               │             │              │
 │          │             │              │ API            │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │←─ onRecentsAnimationStart ────│               │             │              │
 │          │             │  (controller, targets)        │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │ 分配targets  │                │               │             │              │
 │          │             │ 到 Remote    │                │               │             │              │
 │          │             │ TargetHandles│                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │ 初始化────────────────────────────────────────→│             │              │
 │          │             │ TaskView                      │               │             │              │
 │          │             │ Simulator                     │               │ setPreview  │              │
 │          │             │                               │               │ setOrientation             │
 │          │             │              │                │               │             │              │
 │          │             │ 设置──────────────────────────────────────────────────────→│              │
 │          │             │ TransformParams               │               │             │              │
 │          │             │              │                │               │             │              │
 │          │ notify─────→│              │                │               │             │              │
 │          │ GestureStarted             │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │ pilfer      │              │                │               │             │              │
 │          │ Pointers()  │              │                │               │             │              │
 │          │             │              │                │               │             │              │
 │ Touch ──→│             │              │                │               │             │              │
 │  MOVE    │ update─────→│              │                │               │             │              │
 │          │ Displacement │              │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │ 计算shift    │                │               │             │              │
 │          │             │ [0,1]        │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │ 更新动画属性─────────────────────────────────→│             │              │
 │          │             │              │                │               │ fullScreen  │              │
 │          │             │              │                │               │ Progress    │              │
 │          │             │              │                │               │ recentsView │              │
 │          │             │              │                │               │ Scale       │              │
 │          │             │              │                │               │             │              │
 │          │             │              │                │               │ apply()─────→│              │
 │          │             │              │                │               │             │              │
 │          │             │              │                │               │             │ create       │
 │          │             │              │                │               │             │ SurfaceParams│
 │          │             │              │                │               │             │              │
 │          │             │              │                │               │←────────────│ onBuild      │
 │          │             │              │                │               │ TargetParams │              │
 │          │             │              │                │               │             │              │
 │          │             │              │                │               │             │ apply────────→│
 │          │             │              │                │               │             │ SurfaceParams│
 │          │             │              │                │               │             │              │
 │          │             │              │                │               │             │              │ setMatrix()
 │          │             │              │                │               │             │              │ setWindowCrop()
 │          │             │              │                │               │             │              │ setCornerRadius()
 │          │             │              │                │               │             │              │ apply()
 │          │             │              │                │               │             │              │
 │          │             │              │                │               │             │              │ ┌─────────┐
 │          │             │              │                │               │             │              │ │ 窗口实时 │
 │          │             │              │                │               │             │              │ │ 变换显示 │
 │          │             │              │                │               │             │              │ └─────────┘
 │          │             │              │                │               │             │              │
 │ (重复 MOVE 事件,持续更新窗口变换...)                                                                      │
 │          │             │              │                │               │             │              │
 │          │             │              │                │               │             │              │
 │ Touch ──→│             │              │                │               │             │              │
 │   UP     │ 计算速度    │              │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │ onGesture──→│              │                │               │             │              │
 │          │ Ended()     │ calculate    │                │               │             │              │
 │          │             │ EndTarget    │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │ 根据endTarget │                │               │             │              │
 │          │             │ 执行结束动画  │                │               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │ ┌────────────┴──────────┐     │               │             │              │
 │          │             │ │                       │     │               │             │              │
 │          │             │ HOME                 RECENTS  │               │             │              │
 │          │             │ │                       │     │               │             │              │
 │          │             │ RectFSpring       Smooth│     │               │             │              │
 │          │             │ Anim              Transition   │               │             │              │
 │          │             │ │                       │     │               │             │              │
 │          │             │ 缩小到                显示│     │               │             │              │
 │          │             │ Hotseat           RecentsView │               │             │              │
 │          │             │ │                       │     │               │             │              │
 │          │             │ finish()───────────────┴─────→│               │             │              │
 │          │             │              │                │               │             │              │
 │          │             │              │                │ finish()      │             │              │
 │          │             │              │                │               │             │              │
 │          │←─ onInteractionGestureFinished ─────────────│               │             │              │
 │          │             │              │                │               │             │              │
 │          │ cleanupAfter│              │                │               │             │              │
 │          │ Gesture()   │              │                │               │             │              │
 │          │             │              │                │               │             │              │
```

---

## Surface变换详解

### 变换矩阵构建过程

TaskViewSimulator在`apply()`方法中构建变换矩阵,完整过程如下:

```java
// TaskViewSimulator.java:458-497

// 1. 基础缩略图矩阵
mMatrix.set(mPositionHelper.getMatrix());
// 处理应用内容与缩略图的缩放、旋转、偏移关系

// 2. TaskView位置平移
mMatrix.postTranslate(mTaskRect.left, mTaskRect.top);
// 将任务矩形放置到正确位置

// 3. 可选的任务矩形变换
if (mTaskRectTransform != null) {
    mMatrix.postConcat(mTaskRectTransform);
}

// 4. 任务主方向和次方向平移
mOrientationState.getOrientationHandler().setPrimary(
    mMatrix, MATRIX_POST_TRANSLATE, taskPrimaryTranslation.value
);
mOrientationState.getOrientationHandler().setSecondary(
    mMatrix, MATRIX_POST_TRANSLATE, taskSecondaryTranslation.value
);

// 5. 网格平移(Grid布局时使用)
mMatrix.postTranslate(taskGridTranslationX.value, taskGridTranslationY.value);

// 6. Carousel缩放
mMatrix.postScale(carouselScale.value, carouselScale.value, pivotX, pivotY);

// 7. RecentsView滚动偏移
mOrientationState.getOrientationHandler().setPrimary(
    mMatrix, MATRIX_POST_TRANSLATE, recentsViewScroll.value
);

// 8. RecentsView缩放(核心:从全屏到Overview的缩放)
mMatrix.postScale(recentsViewScale.value, recentsViewScale.value, mPivot.x, mPivot.y);

// 9. RecentsView平移
mOrientationState.getOrientationHandler().setSecondary(
    mMatrix, MATRIX_POST_TRANSLATE, recentsViewSecondaryTranslation.value
);
mOrientationState.getOrientationHandler().setPrimary(
    mMatrix, MATRIX_POST_TRANSLATE, recentsViewPrimaryTranslation.value
);

// 10. 窗口到Home的旋转(处理屏幕旋转)
applyWindowToHomeRotation(mMatrix);
```

### 关键变换参数说明

| 参数 | 取值范围 | 含义 | 作用 |
|------|---------|------|------|
| `fullScreenProgress` | [0, 1] | 全屏进度 | 0=应用内全屏, 1=Overview状态 |
| `recentsViewScale` | [fullScreenScale, 1] | RecentsView缩放 | 控制从全屏到缩略图的缩放 |
| `mCurrentShift` | [0, 1] | 当前偏移 | 手势进度,0=起始, 1=Overview |
| `taskPrimaryTranslation` | 像素值 | 主方向平移 | 垂直/水平平移(取决于方向) |
| `recentsViewScroll` | 像素值 | RecentsView滚动 | 快速切换时的任务卡片滚动 |
| `cornerRadius` | 像素值 | 圆角半径 | 动态调整窗口圆角 |

### 裁剪区域计算

```java
// TaskViewSimulator.java:341-346
public RectF getCurrentCropRect() {
    // 裁剪矩形是缩略图矩阵的逆矩阵
    mTempRectF.set(0, 0, mTaskRect.width(), mTaskRect.height());
    mInversePositionMatrix.mapRect(mTempRectF);
    return mTempRectF;
}
```

裁剪区域通过逆矩阵计算,确保窗口内容正确显示在缩略图区域内。

---

## 状态机流程

AbsSwipeUpHandler使用`MultiStateCallback`管理复杂的状态机:

### 核心状态组合

```
1. Launcher Present + Gesture Started
   → onLauncherPresentAndGestureStarted()
   → 开始关联Launcher组件

2. Launcher Drawn + Gesture Started
   → initializeLauncherAnimationController()
   → 初始化Launcher动画控制器

3. App Controller Received + Launcher Drawn + Capture Screenshot
   → switchToScreenshot()
   → 切换到截图显示

4. Screenshot Captured + Gesture Completed + Scaled Controller Recents
   → finishCurrentTransitionToRecents()
   → 完成进入最近任务的过渡

5. Screenshot Captured + Gesture Completed + Scaled Controller Home
   → finishCurrentTransitionToHome()
   → 完成回到桌面的过渡
```

### 状态依赖图

```
                    ┌─────────────────┐
                    │   Gesture开始    │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │STATE_GESTURE_   │
                    │   STARTED       │
                    └────────┬────────┘
                             │
            ┌────────────────┴────────────────┐
            │                                 │
    ┌───────▼──────┐                  ┌──────▼────────┐
    │STATE_LAUNCHER│                  │STATE_APP_     │
    │  _PRESENT    │                  │CONTROLLER_    │
    └───────┬──────┘                  │RECEIVED       │
            │                         └──────┬────────┘
    ┌───────▼──────┐                        │
    │STATE_LAUNCHER│                        │
    │  _DRAWN      │                        │
    └───────┬──────┘                        │
            │                                │
            └────────────┬───────────────────┘
                         │
                ┌────────▼────────┐
                │初始化Launcher    │
                │AnimationController
                └────────┬────────┘
                         │
                ┌────────▼────────┐
                │STATE_CAPTURE_   │
                │ SCREENSHOT      │
                └────────┬────────┘
                         │
                ┌────────▼────────┐
                │STATE_SCREENSHOT_│
                │   CAPTURED      │
                └────────┬────────┘
                         │
                ┌────────▼────────┐
                │STATE_GESTURE_   │
                │  COMPLETED      │
                └────────┬────────┘
                         │
        ┌────────────────┴────────────────┐
        │                                 │
┌───────▼──────┐                  ┌───────▼──────┐
│STATE_SCALED_ │                  │STATE_SCALED_ │
│CONTROLLER_   │                  │CONTROLLER_   │
│   HOME       │                  │  RECENTS     │
└───────┬──────┘                  └───────┬──────┘
        │                                 │
        │                                 │
┌───────▼──────┐                  ┌───────▼──────┐
│finish回到桌面 │                  │finish进入    │
│              │                  │最近任务      │
└──────────────┘                  └──────────────┘
```

---

## 关键数据流

### 手势位移到Surface变换的数据流

```
用户手指移动距离 (pixels)
    │
    ▼
OtherActivityInputConsumer.getDisplacement(ev)
    │ displacement = ev.getY() - mDownPos.y  (底部导航栏)
    ▼
AbsSwipeUpHandler.updateDisplacement(displacement)
    │ shift = displacement / mTransitionDragLength
    │ mCurrentShift.updateValue(shift)  // [0, 1]
    ▼
onCurrentShiftUpdated()
    │ fullScreenProgress = Utilities.boundToRange(mCurrentShift.value, 0, 1)
    ▼
TaskViewSimulator.fullScreenProgress.value = fullScreenProgress
    │
    ▼
TaskViewSimulator.apply(mTransformParams)
    │ mCurrentFullscreenParams.setProgress(fullScreenProgress, ...)
    │
    │ recentsViewScale = interpolate(fullScreenScale, 1.0, fullScreenProgress)
    │ cornerRadius = interpolate(windowCornerRadius, taskViewCornerRadius, fullScreenProgress)
    │
    ▼
构建变换矩阵 mMatrix
    │ mMatrix = thumbnail matrix × taskRect transform × recentsView scale × ...
    ▼
TransformParams.createSurfaceParams(this)
    │
    ▼
onBuildTargetParams(builder, app, params)
    │ builder.setMatrix(mMatrix)
    │        .setWindowCrop(cropRect)
    │        .setCornerRadius(cornerRadius)
    │        .setAlpha(alpha)
    ▼
SurfaceTransaction.apply()
    │ transaction.setMatrix(leash, matrix)
    │ transaction.setWindowCrop(leash, crop)
    │ transaction.setCornerRadius(leash, radius)
    │ transaction.apply()
    ▼
第三方应用窗口实时变换显示
```

---

## 性能优化要点

### 1. 双缓冲与VSync同步

```java
// TransformParams中使用SurfaceTransactionApplier
mSyncTransactionApplier.scheduleApply(surfaceTransaction);
```

`SurfaceTransactionApplier`确保Surface事务在VSync信号时应用,避免画面撕裂。

### 2. 批处理事件

```java
// OtherActivityInputConsumer.java:420-421
// 检测到手势后启用批处理,减少事件处理频率
mInputEventReceiver.setBatchingEnabled(true);
```

### 3. 矩阵复用

TaskViewSimulator中大量使用矩阵复用,避免频繁创建对象:

```java
private final Matrix mMatrix = new Matrix();
private final Matrix mMatrixTmp = new Matrix();
private final RectF mTempRectF = new RectF();
private final float[] mTempPoint = new float[2];
```

### 4. 延迟初始化

```java
// 延迟启动动画直到确认手势意图
if (mIsDeferredDownTarget) {
    // 等到 ACTION_MOVE 超过阈值才启动
    startTouchTrackingForWindowAnimation(ev.getEventTime());
}
```

---

## 常见问题与调试

### Q1: 动画卡顿如何排查?

**排查步骤**:
1. 检查`onCurrentShiftUpdated()`调用频率
2. 使用`TraceHelper`添加trace点分析耗时
3. 检查Surface事务是否正确同步到VSync

```java
TraceHelper.INSTANCE.beginSection("updateDisplacement");
// ... 代码 ...
TraceHelper.INSTANCE.endSection();
```

### Q2: 窗口变换不正确?

**可能原因**:
1. TaskViewSimulator的`mLayoutValid`为false,需要重新计算
2. TransformParams的progress值异常
3. 旋转状态不正确

**调试方法**:
```java
// TaskViewSimulator.java:510-528
// 启用DEBUG模式查看详细变换参数
private static final boolean DEBUG = true;
```

### Q3: 手势被其他组件拦截?

**检查项**:
1. `mPassedPilferInputSlop`是否正确设置为true
2. `pilferPointers()`是否被调用
3. 检查其他InputConsumer的优先级

---

## 总结

第三方应用上滑进入最近任务的动画流程涉及多个核心组件的紧密协作:

1. **OtherActivityInputConsumer** 负责触摸事件的检测和手势识别
2. **AbsSwipeUpHandler** 作为核心协调者,管理整个动画流程的状态机
3. **RecentsAnimationTargets** 提供动画目标窗口的信息
4. **TaskViewSimulator** 模拟任务视图的布局和变换
5. **TransformParams** 管理变换参数并应用到Surface

整个流程通过精密的状态机控制、实时的矩阵变换计算和高效的Surface事务应用,实现了流畅的应用缩放预览效果。

核心思想是:
- **手势检测**: 通过角度和距离判断用户意图
- **状态驱动**: 使用MultiStateCallback管理复杂的异步流程
- **实时变换**: 手势位移实时映射到Surface变换
- **平滑过渡**: 手势结束后根据速度和位置决定最终目标,执行平滑动画

理解这套机制对于定制Android桌面动画、优化手势交互体验至关重要。
